<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Ticketing System - Nightcore</title>
    <style>
        :root {
    --primary-color: #ff6ec7; /* Pink */
    --secondary-color: #9d4edd; /* Purple */
    --tertiary-color: #4361ee; /* Blue */
    --background-color: #1a1a2e; /* Dark blue */
    --text-color: #e6e6e6;
    --card-bg: #16213e;
    --success-color: #4cc9f0; /* Cyan */
    --warning-color: #f8961e; /* Orange */
    --danger-color: #f72585; /* Magenta */
    --light-gray: #2d3047;
    --dark-accent: #0f1419;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--background-color), var(--dark-accent));
    color: var(--text-color);
    line-height: 1.6;
    min-height: 100vh;
}

.app-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

header {
    text-align: center;
    margin-bottom: 2rem;
    position: relative;
}

header h1 {
    margin-bottom: 1rem;
    color: var(--primary-color);
    font-size: 2.5rem;
    text-shadow: 0 0 10px rgba(255, 110, 199, 0.5);
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    background-color: rgba(22, 33, 62, 0.8);
    padding: 10px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 110, 199, 0.2);
}

.nav-btn {
    padding: 12px 24px;
    border: none;
    background-color: transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    color: var(--text-color);
    position: relative;
    overflow: hidden;
}

.nav-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 110, 199, 0.2), transparent);
    transition: left 0.5s;
}

.nav-btn:hover::before {
    left: 100%;
}

.nav-btn.active {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    box-shadow: 0 0 15px rgba(255, 110, 199, 0.5);
}

.tab-content {
    display: none;
    animation: fadeIn 0.5s;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- Form and Ticket --- */
.form-and-ticket {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
}

form {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 110, 199, 0.1);
}

form h2 {
    margin-bottom: 1.5rem;
    text-align: center;
    color: var(--primary-color);
}

form input, form select {
    width: 100%;
    padding: 12px;
    margin-bottom: 1rem;
    border: 1px solid rgba(255, 110, 199, 0.3);
    border-radius: 8px;
    font-size: 1rem;
    background-color: var(--light-gray);
    color: var(--text-color);
    transition: all 0.3s ease;
}

form input:focus, form select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 10px rgba(255, 110, 199, 0.3);
}

.phone-input {
    display: flex;
    align-items: center;
}
.phone-input span {
    padding: 12px;
    background: linear-gradient(135deg, var(--secondary-color), var(--tertiary-color));
    border: 1px solid rgba(255, 110, 199, 0.3);
    border-right: none;
    border-radius: 8px 0 0 8px;
    color: white;
    height: 44px;
    display: flex;
    align-items: center;
}
.phone-input input {
    border-radius: 0 8px 8px 0;
    margin-bottom: 0;
    flex: 1;
}

form button, .booked-controls button, .ticket-actions button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(157, 78, 221, 0.3);
}

form button:hover, .booked-controls button:hover, .ticket-actions button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(157, 78, 221, 0.5);
}
.ticket-actions button:disabled {
    background: var(--light-gray);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.ticket-preview-container {
    padding: 2rem;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 110, 199, 0.1);
}

#ticketTemplate {
    border: 2px dashed var(--primary-color);
    border-radius: 15px;
    padding: 20px;
    background: linear-gradient(135deg, var(--card-bg), var(--light-gray));
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
    width: 100%;
}

#ticketTemplate::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,110,199,0.1) 0%, rgba(157,78,221,0.05) 50%, transparent 70%);
    animation: pulse 4s infinite linear;
    z-index: 0;
}

@keyframes pulse {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.ticket-header, .ticket-footer {
    text-align: center;
    position: relative;
    z-index: 1;
}
.ticket-header {
    border-bottom: 1px solid rgba(255, 110, 199, 0.3);
    padding-bottom: 10px;
    margin-bottom: 10px;
}
.ticket-footer {
    border-top: 1px solid rgba(255, 110, 199, 0.3);
    padding-top: 10px;
    margin-top: 10px;
    font-size: 0.8rem;
    color: #aaa;
}

.ticket-body {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    position: relative;
    z-index: 1;
}

.ticket-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ticket-details div {
    display: flex;
    align-items: center;
    gap: 10px;
}

.ticket-details strong {
    min-width: 80px;
    color: var(--primary-color);
}

.ticket-qr {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 140px;
    min-height: 140px;
    background: white;
    border-radius: 8px;
    padding: 10px;
    margin-left: 10px;
}
#qrcode img {
    width: 120px;
    height: 120px;
}

.ticket-serial {
    margin-top: 10px;
    font-size: 0.8rem;
    color: #777;
    text-align: center;
}

.ticket-actions {
    display: flex;
    gap: 1rem;
}

/* --- Booked Tickets Tab --- */
#booked h2, #scanner h2, #settings h2 {
    text-align: center;
    margin-bottom: 1.5rem;
    color: var(--primary-color);
}

.booked-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 1rem;
}
.booked-controls button { 
    width: auto; 
    padding: 10px 20px; 
    border-radius: 8px;
}
#deleteBtn { 
    background: linear-gradient(135deg, var(--danger-color), #b5179e);
}
#deleteBtn:hover { 
    box-shadow: 0 6px 20px rgba(247, 37, 133, 0.5);
}

/* Table style for booked tickets */
.tickets-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: var(--card-bg);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.tickets-table th {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
}

.tickets-table td {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255, 110, 199, 0.1);
}

.tickets-table tr:last-child td {
    border-bottom: none;
}

.tickets-table tr:hover {
    background-color: rgba(255, 110, 199, 0.05);
}

.status-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-weight: bold;
    color: white;
    text-align: center;
    display: inline-block;
    min-width: 100px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.status-coming-soon { 
    background: linear-gradient(135deg, var(--warning-color), #f3722c);
}
.status-arrived { 
    background: linear-gradient(135deg, var(--success-color), #4895ef);
}
.status-didnt-come { 
    background: linear-gradient(135deg, var(--danger-color), #b5179e);
}

.view-ticket-btn {
    padding: 6px 12px;
    background: linear-gradient(135deg, var(--tertiary-color), #3a0ca3);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.view-ticket-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(67, 97, 238, 0.5);
}

.select-all-container {
    padding: 10px;
    background: var(--light-gray);
    border-radius: 8px;
    margin-bottom: 1rem;
    display: none;
}

/* --- Settings Tab --- */
.settings-form {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 110, 199, 0.1);
    max-width: 600px;
    margin: 0 auto;
}

.settings-form h3 {
    color: var(--primary-color);
    margin-bottom: 1rem;
    text-align: center;
}

.settings-form label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.settings-form input {
    width: 100%;
    padding: 10px;
    margin-bottom: 1rem;
    border: 1px solid rgba(255, 110, 199, 0.3);
    border-radius: 8px;
    background-color: var(--light-gray);
    color: var(--text-color);
}

.settings-form button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(157, 78, 221, 0.3);
}

.settings-form button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(157, 78, 221, 0.5);
}

.current-settings {
    margin-top: 2rem;
    padding: 1rem;
    background: var(--light-gray);
    border-radius: 10px;
}

.current-settings h4 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

/* --- Scanner --- */
#scanner-container {
    position: relative;
    width: 100%;
    max-width: 500px;
    margin: 0 auto 1rem auto;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

#scanner-video {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 15px;
}

.scanner-box {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 70%;
    height: 50%;
    transform: translate(-50%, -50%);
    border: 3px solid rgba(255, 110, 199, 0.8);
    box-shadow: 0 0 0 4000px rgba(0,0,0,0.5);
    border-radius: 10px;
}

#startScanBtn {
    display: block;
    margin: 1rem auto;
    width: auto;
    padding: 10px 30px;
    border-radius: 8px;
}

#scanResult {
    text-align: center;
    margin-top: 1rem;
    padding: 15px;
    border-radius: 8px;
    font-size: 1.2rem;
    font-weight: bold;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    opacity: 1;
    visibility: visible;
}

.result-success { 
    background: linear-gradient(135deg, rgba(76, 201, 240, 0.2), rgba(72, 149, 239, 0.2)); 
    color: #4cc9f0;
    border: 1px solid rgba(76, 201, 240, 0.3);
}

.result-error { 
    background: linear-gradient(135deg, rgba(247, 37, 133, 0.2), rgba(181, 23, 158, 0.2)); 
    color: #f72585;
    border: 1px solid rgba(247, 37, 133, 0.3);
}

.result-info { 
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.2), rgba(58, 12, 163, 0.2)); 
    color: var(--tertiary-color);
    border: 1px solid rgba(67, 97, 238, 0.3);
}

/* --- Modal --- */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: var(--card-bg);
    margin: 15% auto;
    padding: 20px;
    border: 1px solid rgba(255, 110, 199, 0.3);
    width: 80%;
    max-width: 500px;
    border-radius: 15px;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.close-btn {
    color: #aaa;
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
}

.close-btn:hover {
    color: var(--primary-color);
}

.modal-content h2 { 
    margin-bottom: 1rem; 
    color: var(--primary-color);
}
.modal-content input { 
    width: 100%; 
    padding: 10px; 
    margin: 1rem 0; 
    background: var(--light-gray);
    border: 1px solid rgba(255, 110, 199, 0.3);
    border-radius: 8px;
    color: var(--text-color);
}
.modal-content button { 
    width: 100%; 
    padding: 10px; 
    border-radius: 8px;
}

/* --- Mobile Responsiveness --- */
@media (max-width: 768px) {
    .form-and-ticket {
        grid-template-columns: 1fr;
    }

    nav {
        flex-wrap: wrap;
    }
    
    .tickets-table {
        display: block;
        overflow-x: auto;
    }

    header h1 {
        font-size: 2rem;
    }
    
    .ticket-body {
        flex-direction: column;
        text-align: center;
    }
    
    .ticket-qr {
        margin: 15px 0 0 0;
    }
    
    .ticket-details div {
        justify-content: center;
    }
}

/* Add some floating elements for visual effect */
.floating-element {
    position: fixed;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(255,110,199,0.2) 0%, transparent 70%);
    border-radius: 50%;
    z-index: -1;
    animation: float 15s infinite linear;
}

.floating-element:nth-child(1) {
    top: 10%;
    left: 5%;
    width: 150px;
    height: 150px;
    animation-duration: 20s;
}

.floating-element:nth-child(2) {
    top: 70%;
    right: 10%;
    width: 120px;
    height: 120px;
    animation-duration: 25s;
    animation-delay: 5s;
}

.floating-element:nth-child(3) {
    bottom: 20%;
    left: 15%;
    width: 80px;
    height: 80px;
    animation-duration: 18s;
    animation-delay: 10s;
}

@keyframes float {
    0% { transform: translate(0, 0) rotate(0deg); }
    25% { transform: translate(20px, 20px) rotate(90deg); }
    50% { transform: translate(0, 40px) rotate(180deg); }
    75% { transform: translate(-20px, 20px) rotate(270deg); }
    100% { transform: translate(0, 0) rotate(360deg); }
}
    </style>
</head>
<body>
    <!-- Floating background elements -->
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>

    <div class="app-container">
        <header>
            <h1>Event Ticketing System</h1>
            <nav>
                <button class="nav-btn active" data-tab="create">Create Ticket</button>
                <button class="nav-btn" data-tab="booked">Booked Tickets</button>
                <button class="nav-btn" data-tab="scanner">Validate Entry</button>
                <button class="nav-btn" data-tab="settings">Settings</button>
            </nav>
        </header>

        <main>
            <!-- ======================= CREATE TICKET TAB ======================= -->
            <div id="create" class="tab-content active">
                <div class="form-and-ticket">
                    <form id="ticketForm">
                        <h2>Enter Attendee Details</h2>
                        <input type="text" id="name" placeholder="Full Name" required>
                        <select id="gender" required>
                            <option value="" disabled selected>Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="number" id="age" placeholder="Age" required min="1">
                        <div class="phone-input">
                            <span>+91</span>
                            <input type="tel" id="phone" placeholder="Phone Number (10 digits)" required pattern="[0-9]{10}">
                        </div>
                        <button type="submit" style="margin-top: 15px !important;">Generate Ticket</button>
                    </form>

                    <div class="ticket-preview-container">
                        <h2>Ticket Preview</h2>
                        <!-- This is the ticket template that will be filled -->
                        <div id="ticketTemplate">
                            <div class="ticket-header">
                                <h3>EVENT ENTRY PASS</h3>
                                <p id="eventNamePlace"></p>
                            </div>
                            <div class="ticket-body">
                                <div class="ticket-details">
                                    <div><span id="ticketName"></span></div>
                                    <div><span id="ticketAgeGender"></span></div>
                                    <div><span id="ticketPhone"></span></div>
                                </div>
                                <div class="ticket-qr">
                                    <div id="qrcode"></div>
                                    <div class="ticket-serial" id="ticketSerial"></div>
                                </div>
                            </div>
                            <div class="ticket-footer">
                                <p>Please present this ticket at the entry.</p>
                            </div>
                        </div>
                        <div class="ticket-actions">
                            <button id="whatsappBtn" disabled>Share on WhatsApp</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================= BOOKED TICKETS TAB ======================= -->
            <div id="booked" class="tab-content">
                <h2>All Booked Tickets</h2>
                <div class="booked-controls">
                    <button id="selectBtn">Select</button>
                    <button id="deleteBtn" style="display: none;">Delete Selected</button>
                </div>
                <div class="select-all-container" style="display: none;">
                    <input type="checkbox" id="selectAllCheckbox">
                    <label for="selectAllCheckbox">Select All</label>
                </div>
                
                <table class="tickets-table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Name</th>
                            <th>Age/Gender</th>
                            <th>Phone</th>
                            <th>Ticket ID</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bookedTicketsTable">
                        <!-- Ticket rows will be generated here by JS -->
                    </tbody>
                </table>
            </div>

            <!-- ======================= SCANNER TAB ======================= -->
            <div id="scanner" class="tab-content">
                <h2>QR Code Scanner</h2>
                <div id="scanner-container">
                    <video id="scanner-video" playsinline></video>
                    <div class="scanner-box"></div>
                </div>
                <button id="startScanBtn">Start Camera</button>
                <div id="scanResult">Point camera at a QR code...</div>
            </div>
            
            <!-- ======================= SETTINGS TAB ======================= -->
            <div id="settings" class="tab-content">
                <h2>Event Settings</h2>
                <div class="settings-form">
                    <h3>Configure Event Details</h3>
                    <form id="eventSettingsForm">
                        <label for="eventName">Event Name</label>
                        <input type="text" id="eventName" placeholder="Enter event name">
                        
                        <label for="eventPlace">Event Place</label>
                        <input type="text" id="eventPlace" placeholder="Enter event place">
                        
                        <label for="arrivalDeadline">Arrival Deadline</label>
                        <input type="datetime-local" id="arrivalDeadline">
                        
                        <button type="submit">Save Settings</button>
                    </form>
                    
                    <div class="current-settings">
                        <h4>Current Settings</h4>
                        <p><strong>Event Name:</strong> <span id="currentEventName">Not set</span></p>
                        <p><strong>Event Place:</strong> <span id="currentEventPlace">Not set</span></p>
                        <p><strong>Arrival Deadline:</strong> <span id="currentDeadline">Not set</span></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- External Libraries -->
    <!-- For Generating QR Codes -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- For Converting HTML to Image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- For Scanning QR Codes -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- Our Custom Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let bookedTickets = []; // Main array to hold all ticket objects
    let isSelectionMode = false;
    let deadlineInterval;
    let scanner = null;
    let eventSettings = {
        name: '',
        place: '',
        deadline: ''
    };

    // --- DOM ELEMENT SELECTORS ---
    const navButtons = document.querySelectorAll('.nav-btn');
    const tabs = document.querySelectorAll('.tab-content');
    const ticketForm = document.getElementById('ticketForm');
    const bookedTicketsTable = document.getElementById('bookedTicketsTable');
    
    // Ticket Preview Elements
    const ticketName = document.getElementById('ticketName');
    const ticketAgeGender = document.getElementById('ticketAgeGender');
    const ticketPhone = document.getElementById('ticketPhone');
    const ticketSerial = document.getElementById('ticketSerial');
    const eventNamePlace = document.getElementById('eventNamePlace');
    const qrcodeContainer = document.getElementById('qrcode');
    const whatsappBtn = document.getElementById('whatsappBtn');
    
    // Booked List Controls
    const selectBtn = document.getElementById('selectBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const selectAllContainer = document.querySelector('.select-all-container');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

    // Scanner Elements
    const startScanBtn = document.getElementById('startScanBtn');
    const scannerVideo = document.getElementById('scanner-video');
    const scanResult = document.getElementById('scanResult');
    
    // Settings Elements
    const eventSettingsForm = document.getElementById('eventSettingsForm');
    const currentEventName = document.getElementById('currentEventName');
    const currentEventPlace = document.getElementById('currentEventPlace');
    const currentDeadline = document.getElementById('currentDeadline');

    // --- INITIALIZATION ---
    loadTicketsFromLocalStorage(); // Load tickets on startup
    loadEventSettings(); // Load event settings on startup

    // --- NAVIGATION ---
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Stop scanner if navigating away
            if (scanner && button.dataset.tab !== 'scanner') {
                stopScan();
            }

            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.id === button.dataset.tab) {
                    tab.classList.add('active');
                }
            });
        });
    });

    // --- EVENT SETTINGS ---
    function loadEventSettings() {
        const storedSettings = localStorage.getItem('eventSettings');
        if (storedSettings) {
            eventSettings = JSON.parse(storedSettings);
            updateSettingsDisplay();
        }
    }

    function saveEventSettings() {
        localStorage.setItem('eventSettings', JSON.stringify(eventSettings));
        updateSettingsDisplay();
    }

    function updateSettingsDisplay() {
        currentEventName.textContent = eventSettings.name || 'Not set';
        currentEventPlace.textContent = eventSettings.place || 'Not set';
        currentDeadline.textContent = eventSettings.deadline ? new Date(eventSettings.deadline).toLocaleString() : 'Not set';
        
        // Update ticket preview with event name and place
        eventNamePlace.textContent = eventSettings.name && eventSettings.place 
            ? `${eventSettings.name} - ${eventSettings.place}` 
            : 'Event details not set';
    }

    eventSettingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        eventSettings.name = document.getElementById('eventName').value;
        eventSettings.place = document.getElementById('eventPlace').value;
        eventSettings.deadline = document.getElementById('arrivalDeadline').value;
        
        saveEventSettings();
        alert('Event settings saved successfully!');
        eventSettingsForm.reset();
    });

    // --- TICKET CREATION ---
    ticketForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const name = document.getElementById('name').value;
        const gender = document.getElementById('gender').value;
        const age = document.getElementById('age').value;
        const phone = document.getElementById('phone').value;

        const ticket = {
            id: 'TICKET-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase(),
            name,
            gender,
            age,
            phone: '+91' + phone,
            status: 'coming-soon', // 'coming-soon', 'arrived', 'didnt-come'
            scanned: false // Track if ticket has been scanned
        };

        // Add new ticket to the beginning of the array (newest first)
        bookedTickets.unshift(ticket);
        saveTicketsToLocalStorage();
        renderBookedTickets();
        updateTicketPreview(ticket);
        ticketForm.reset();
    });

    function updateTicketPreview(ticket) {
        ticketName.textContent = ticket.name;
        ticketAgeGender.textContent = `${ticket.age} / ${ticket.gender}`;
        ticketPhone.textContent = ticket.phone;
        ticketSerial.textContent = ticket.id;

        // Generate QR Code
        qrcodeContainer.innerHTML = ''; // Clear previous QR
        new QRCode(qrcodeContainer, {
            text: ticket.id,
            width: 128,
            height: 128,
            correctLevel: QRCode.CorrectLevel.H // High correction level for better scanability
        });
        
        // Enable action button
        whatsappBtn.disabled = false;
    }

    // --- TICKET ACTIONS (WhatsApp Sharing) ---
    whatsappBtn.addEventListener('click', () => {
        const ticketTemplate = document.getElementById('ticketTemplate');
        
        // Create and download the ticket image
        html2canvas(ticketTemplate, { scale: 3 }).then(canvas => {
            // Create download link
            const link = document.createElement('a');
            link.download = `ticket-${ticketSerial.textContent}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            // Open WhatsApp with pre-filled message
            const phone = ticketPhone.textContent.replace('+', '');
            const message = encodeURIComponent(
    `Hello ${ticketName.textContent}, here is your event ticket. 
*_[Note down the serial number in case the pass image gets deleted and you need to reissue your pass.]_*`
);
window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            
            // Reset form for next ticket
            setTimeout(() => {
                ticketForm.reset();
                whatsappBtn.disabled = true;
                qrcodeContainer.innerHTML = '';
                ticketName.textContent = '';
                ticketAgeGender.textContent = '';
                ticketPhone.textContent = '';
                ticketSerial.textContent = '';
            }, 1000);
        });
    });

    // --- BOOKED TICKETS MANAGEMENT ---
    function renderBookedTickets() {
        bookedTicketsTable.innerHTML = '';
        if(bookedTickets.length === 0) {
            bookedTicketsTable.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#777; padding: 20px;">No tickets booked yet.</td></tr>';
            return;
        }

        // Display newest tickets first (already sorted by unshift)
        bookedTickets.forEach(ticket => {
            const tr = document.createElement('tr');
            tr.dataset.id = ticket.id;
            tr.innerHTML = `
                <td>
                    <div class="checkbox-container">
                        <input type="checkbox" class="ticket-checkbox">
                    </div>
                </td>
                <td>${ticket.name}</td>
                <td>${ticket.age} / ${ticket.gender}</td>
                <td>${ticket.phone}</td>
                <td class="serial">${ticket.id}</td>
                <td><span class="status-badge status-${ticket.status}">${ticket.status.replace('-', ' ')}</span></td>
                <td><button class="view-ticket-btn" data-id="${ticket.id}">View</button></td>
            `;
            bookedTicketsTable.appendChild(tr);
        });

        // Add event listeners to view buttons
        document.querySelectorAll('.view-ticket-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const ticketId = e.target.dataset.id;
                const ticket = bookedTickets.find(t => t.id === ticketId);
                if (ticket) {
                    // Switch to Create Ticket tab
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelector('[data-tab="create"]').classList.add('active');
                    tabs.forEach(tab => tab.classList.remove('active'));
                    document.getElementById('create').classList.add('active');
                    
                    // Update preview with selected ticket
                    updateTicketPreview(ticket);
                    whatsappBtn.disabled = false;
                }
            });
        });
    }

    selectBtn.addEventListener('click', () => {
        isSelectionMode = !isSelectionMode;
        document.querySelector('.tickets-table').classList.toggle('selection-mode', isSelectionMode);
        deleteBtn.style.display = isSelectionMode ? 'inline-block' : 'none';
        selectAllContainer.style.display = isSelectionMode ? 'block' : 'none';
        selectBtn.textContent = isSelectionMode ? 'Cancel' : 'Select';
        if (!isSelectionMode) {
            // Uncheck all when exiting selection mode
            document.querySelectorAll('.ticket-checkbox').forEach(cb => cb.checked = false);
            selectAllCheckbox.checked = false;
        }
    });

    selectAllCheckbox.addEventListener('change', (e) => {
        document.querySelectorAll('.ticket-checkbox').forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });

    deleteBtn.addEventListener('click', () => {
        const selectedIds = [];
        document.querySelectorAll('.ticket-checkbox:checked').forEach(checkbox => {
            const ticketRow = checkbox.closest('tr');
            selectedIds.push(ticketRow.dataset.id);
        });

        if (selectedIds.length === 0) {
            alert('Please select tickets to delete.');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${selectedIds.length} ticket(s)?`)) {
            bookedTickets = bookedTickets.filter(ticket => !selectedIds.includes(ticket.id));
            saveTicketsToLocalStorage();
            renderBookedTickets();
            // Exit selection mode after deleting
            selectBtn.click();
        }
    });

    // --- SCANNER LOGIC ---
    startScanBtn.addEventListener('click', () => {
        if (scannerVideo.srcObject) {
            stopScan();
        } else {
            startScan();
        }
    });

    function startScan() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            const constraints = {
                video: { facingMode: 'environment' } // Use the rear camera
            };

            navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
                scannerVideo.srcObject = stream;
                scannerVideo.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                scannerVideo.play();
                startScanBtn.textContent = 'Stop Camera';
                scanResult.textContent = 'Point camera at a QR code...';
                scanResult.className = 'result-info';
                scanResult.style.display = 'flex';
                requestAnimationFrame(tick);
            }).catch(function(err) {
                console.error("Error accessing camera: ", err);
                scanResult.textContent = 'Could not access camera.';
                scanResult.className = 'result-error';
                scanResult.style.display = 'flex';
            });
        }
    }

    function stopScan() {
        if (scannerVideo.srcObject) {
            scannerVideo.srcObject.getTracks().forEach(track => track.stop());
        }
        scannerVideo.srcObject = null;
        startScanBtn.textContent = 'Start Camera';
    }
    
    function tick() {
        if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
            const canvasElement = document.createElement('canvas');
            const canvas = canvasElement.getContext('2d');
            canvasElement.height = scannerVideo.videoHeight;
            canvasElement.width = scannerVideo.videoWidth;
            canvas.drawImage(scannerVideo, 0, 0, canvasElement.width, canvasElement.height);
            const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                validateTicket(code.data);
                stopScan();
            } else {
                if (scannerVideo.srcObject) { // Continue scanning if not stopped
                   requestAnimationFrame(tick);
                }
            }
        } else {
             if (scannerVideo.srcObject) {
                requestAnimationFrame(tick);
             }
        }
    }

    function validateTicket(ticketId) {
        const ticket = bookedTickets.find(t => t.id === ticketId);

        if (ticket) {
            if (ticket.status === 'coming-soon' && !ticket.scanned) {
                ticket.status = 'arrived';
                ticket.scanned = true;
                saveTicketsToLocalStorage();
                renderBookedTickets();
                
                // Play beep sound
                playBeepSound();
                
                scanResult.textContent = `Success! Welcome, ${ticket.name}. Ticket ID: ${ticket.id}`;
                scanResult.className = 'result-success';
                scanResult.style.display = 'flex';
            } else if (ticket.scanned) {
                // Play error sound for already scanned ticket
                playErrorSound();
                
                scanResult.textContent = `Error: Ticket for ${ticket.name} (ID: ${ticket.id}) has already been scanned.`;
                scanResult.className = 'result-error';
                scanResult.style.display = 'flex';
            } else {
                // Play error sound for other invalid tickets
                playErrorSound();
                
                scanResult.textContent = `Error: Ticket for ${ticket.name} (ID: ${ticket.id}) is marked as 'Didn't Come'.`;
                scanResult.className = 'result-error';
                scanResult.style.display = 'flex';
            }
        } else {
            // Play error sound for invalid ticket
            playErrorSound();
            
            scanResult.textContent = 'Invalid Ticket ID. Not found in the system.';
            scanResult.className = 'result-error';
            scanResult.style.display = 'flex';
        }
    }

    // Beep sound function
    function playBeepSound() {
        try {
            const beep = new Audio('/smoke-detector-beep.mp3');
            beep.play().catch(e => console.log('Audio play failed:', e));
        } catch (e) {
            console.log('Audio play failed:', e);
        }
    }

    // Error sound function
    function playErrorSound() {
        try {
            const errorSound = new Audio('/steamos-error.mp3');
            errorSound.play().catch(e => console.log('Audio play failed:', e));
        } catch (e) {
            console.log('Audio play failed:', e);
        }
    }

    // --- LOCAL STORAGE ---
    function saveTicketsToLocalStorage() {
        localStorage.setItem('eventTickets', JSON.stringify(bookedTickets));
    }

    function loadTicketsFromLocalStorage() {
        const storedTickets = localStorage.getItem('eventTickets');
        if (storedTickets) {
            bookedTickets = JSON.parse(storedTickets);
            renderBookedTickets();
        }
    }
});
    </script>
</body>
</html>
